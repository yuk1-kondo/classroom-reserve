rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 管理者権限チェック（Firestore ドキュメントベース）
    function isAdmin() {
      return request.auth != null && (
        // UIDベース
        exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)) ||
        // メールアドレスベース（admin_users/{email} も許可）
        (request.auth.token.email != null &&
          exists(/databases/$(database)/documents/admin_users/$(request.auth.token.email)))
      );
    }
    
    // 認証済みユーザーかチェック
    function isAuthenticated() {
      return request.auth != null;
    }

    // 管理者ユーザー管理コレクション
    match /admin_users/{userId} {
      // 認証済みユーザーは読み取り可能（管理者判定のため）
      allow read: if isAuthenticated();
      // 管理者のみ書き込み可能
      allow write: if isAdmin();
    }

    // ユーザープロファイル（UID→emailマップ）
    match /user_profiles/{uid} {
      // 読み取り: 認証済みユーザー（管理者追加時に逆引きするため）
      allow read: if isAuthenticated();
      // 書き込み: 認証済み本人のみ（ログイン時の upsert 用）
      allow write: if isAuthenticated() && request.auth.uid == uid;
    }

    // 教室と時限データは誰でも読み取り可能
    match /rooms/{roomId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    match /periods/{periodId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // 予約情報は誰でも読み取り可能、書き込みは認証済みユーザーのみ
    match /reservations/{reservationId} {
      allow read: if true;
      // 作成は認証済み + 作成者一致 + 先日付制限内（設定が存在すれば）
      // 管理者の場合は日付制限をスキップ
      allow create: if isAuthenticated()
        && request.resource.data.createdBy == request.auth.uid
        && (
          // 管理者の場合は制限なし
          isAdmin()
          // 設定が無ければ制限なし
          || !exists(/databases/$(database)/documents/system_settings/global)
          || get(/databases/$(database)/documents/system_settings/global).data.reservationMaxTimestamp == null
          || request.resource.data.startTime <= get(/databases/$(database)/documents/system_settings/global).data.reservationMaxTimestamp
        );
    // 更新は作成者 または 管理者
    allow update: if isAuthenticated() && (
      request.auth.uid == resource.data.createdBy || isAdmin()
    );
    // 削除は作成者 または 管理者 または 会議室予約（パスコード認証はクライアント側で実施）
    allow delete: if isAuthenticated() && (
      request.auth.uid == resource.data.createdBy ||
      isAdmin() ||
      resource.data.roomName == '会議室'
    );
    }

    // 予約スロット用コレクション（同時予約防止のための占有情報）
    match /reservation_slots/{slotId} {
      allow read: if true;
      // 認証済みのみ作成/削除を許可（実利用では Cloud Functions 側管理が理想）
      allow write: if isAuthenticated();
    }

    // 月次サマリー（現在は利用していないが削除処理の整合性維持に必要）
    match /month_overview/{monthId} {
      allow read: if true;
      // 運用上問題ないため認証済みユーザーに書き込みを許可
      allow write: if isAuthenticated();
    }

    // システム設定（予約制限など）
    match /system_settings/{docId} {
      // 誰でも読み取り可能（UI 表示用）。必要に応じて認証済みに制限可。
      allow read: if true;
      // 書き込みは管理者のみ
      allow write: if isAdmin();
    }

    // 固定（毎週）予約テンプレート
    match /weekly_templates/{templateId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // 予約禁止期間（管理者が設定、一般ユーザーは読み取りのみ）
    match /blocked_periods/{blockId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
