rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 管理者権限チェック（Firestore ドキュメントベース）
    function isAdmin() {
      return request.auth != null && (
        // UIDベース
        exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)) ||
        // メールアドレスベース（admin_users/{email} も許可）
        (request.auth.token.email != null &&
          exists(/databases/$(database)/documents/admin_users/$(request.auth.token.email)))
      );
    }
    
    // 認証済みユーザーかチェック
    function isAuthenticated() {
      return request.auth != null;
    }

    // 管理者ユーザー管理コレクション
    match /admin_users/{userId} {
      // 認証済みユーザーは読み取り可能（管理者判定のため）
      allow read: if isAuthenticated();
      // 管理者のみ書き込み可能
      allow write: if isAdmin();
    }

    // ユーザープロファイル（UID→emailマップ）
    match /user_profiles/{uid} {
      // 読み取り: 認証済みユーザー（管理者追加時に逆引きするため）
      allow read: if isAuthenticated();
      // 書き込み: 認証済み本人のみ（ログイン時の upsert 用）
      allow write: if isAuthenticated() && request.auth.uid == uid;
    }

    // 教室と時限データは誰でも読み取り可能
    match /rooms/{roomId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    match /periods/{periodId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // 予約情報は誰でも読み取り可能、書き込みは認証済みユーザーのみ
    match /reservations/{reservationId} {
      allow read: if true;
      // 作成は認証済み + 作成者一致 + 先日付制限内（設定が存在すれば）
      allow create: if isAuthenticated()
        && request.resource.data.createdBy == request.auth.uid
        && (
          // 設定が無ければ制限なし
          !exists(/databases/$(database)/documents/system_settings/global)
          || get(/databases/$(database)/documents/system_settings/global).data.reservationMaxTimestamp == null
          || request.resource.data.startTime <= get(/databases/$(database)/documents/system_settings/global).data.reservationMaxTimestamp
        );
    // 更新は作成者のみ
    allow update: if isAuthenticated() && request.auth.uid == resource.data.createdBy;
    // 削除は作成者 または 管理者（uid/email のどちらかが admin_users に存在）
    allow delete: if isAuthenticated() && (
      request.auth.uid == resource.data.createdBy || (
        exists(/databases/$(database)/documents/admin_users/$(request.auth.uid)) ||
        (request.auth.token.email != null && exists(/databases/$(database)/documents/admin_users/$(request.auth.token.email)))
      )
    );
    }

    // 予約スロット用コレクション（同時予約防止のための占有情報）
    match /reservation_slots/{slotId} {
      allow read: if true;
      // 認証済みのみ作成/削除を許可（実利用では Cloud Functions 側管理が理想）
      allow write: if isAuthenticated();
    }

    // システム設定（予約制限など）
    match /system_settings/{docId} {
      // 誰でも読み取り可能（UI 表示用）。必要に応じて認証済みに制限可。
      allow read: if true;
      // 書き込みは管理者のみ
      allow write: if isAdmin();
    }

    // 固定（毎週）予約テンプレート
    match /weekly_templates/{templateId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
